# E2E Scenarios (Candidate)

- Status: Draft
- Last Updated: 2025-09-27

## 目的
Playwright で自動化するシナリオ候補を整理し、優先順位を決める判断材料にする。段階的に導入しやすいよう、複雑度ごとの選択肢を提示する。

---

## 1. シナリオ候補（複雑度別）

### A. スモーク最小構成（シンプル）
- **目的**: `/play` → `/result` の基本フローが壊れていないことを即座に検知。
- **手順**
  1. `/play` にアクセスし、自動スタートを待つ。
  2. 1問目の選択肢をクリック → 「Next」で次へ → 10問分の回答を高速に選択（ハードコードされたモック回答を利用）。
  3. `/result` へ遷移したことを確認し、スコアバッジや回答一覧が表示されているか検証。
- **利点**: 実装工数が最小。main ブランチ保護用として早期に導入可能。
- **制約**: 正誤や Reveal リンクなど細かい機能は検証しない。

### B. 機能カバレッジ重視（バランス型）
- **目的**: 基本フローに加えて、Reveal カード・設定トグル・Result 詳細表示を検証。
- **手順の例**
  1. スモークシナリオに加え、一部の回答で故意に不正解／タイムアウトを作る。
  2. Reveal 画面で「Open in …」リンクをクリックし、`target="_blank"` であることを検証。
  3. Inline playback トグルを ON/OFF し、ページ再読み込み後も状態が保持されることを確認。
  4. `/result` の各問題カードで残秒・ポイントが表示されているか確認。
- **利点**: ユーザー体験に近い形で広範囲をテストできる。
- **制約**: タイムアウトやメトリクス検証などの再現に工夫が必要。
- **進捗メモ**: `tests/e2e/play-features.spec.ts` でリンク属性・トグル永続化・正誤混在サマリ・タイムアウト扱い・リンク未提供/未対応 provider フォールバック・主要メトリクスイベント（トグル/回答結果/リンククリック）と 429 リトライをカバー済み。残タスクは異常系リンク（無効URLのさらなるバリエーション等）やメトリクス異常系（連続失敗、sendBeacon 経路など）の検証。

### C. 耐久・ネットワーク系（複雑）
- **目的**: オフライン → 復帰やメトリクスキュー挙動まで含めた耐久性の確認。
- **手順の例**
  1. Playwright の `context.route` などを使って `/v1/metrics` を一時的に失敗させ、再送されることを確認。
  2. `page.goto` 途中で offline モードに切り替え、エラーバナー表示を検証。
  3. `localStorage` の `vgm2.metrics.queue` や `client_id` が期待通り更新されるか検証。
- **利点**: 実環境に近い異常系を自動化できる。
- **制約**: 実装とメンテナンスの難易度が高い。安定運用には時間がかかる。

---

## 2. 優先順位の提案
1. **ステップ1**: シナリオ A（スモーク）を最優先で実装し、CI に組み込む。
2. **ステップ2**: シナリオ B から重要なケースを順次追加（例: Reveal リンク・設定トグル）。
3. **ステップ3**: 必要に応じてシナリオ C を個別ジョブとして整備。

---

## 3. テストデータ活用メモ
- MSW の `answers.ts` で全問の正解が分かるため、Playwright から `import` して deterministic に回答可能。
- タイムアウトを再現したい場合は `Timer` の UI を使わず、`processAnswer` 呼び出しのタイミングを調整する（`waitForTimeout` 等）。

---

## 4. 未決定事項（要検討）
- Playwright テストで metrics API の送信内容まで検査するか。 → `page.on('request')` で傍受は可能。
- CI での想定ブラウザ数（Chromium のみか、Firefox/ WebKit も含めるか）。
- 将来的な実 BE 接続時のテスト方針（モード切り替え / スタブ差し替え）。
